import{b as h,e as g,f as _,h as r,p as D,F as C,l as R,j,t as x,v as M,q as V,_ as L,x as S,o as E,y as I,i as O,u as U}from"./index-BL72d3rg.js";import{l as B}from"./index-CA1CrNgP.js";const N={class:"chat-panel border rounded-xl p-3 mt-4"},P={class:"messages h-40 overflow-y-auto mb-2"},$={__name:"ChatPanel",props:{messages:Array},emits:["send"],setup(y,{emit:m}){const l=m,d=h(""),p=()=>{d.value.trim()&&(l("send",{user:"User",text:d.value}),d.value="")};return(v,i)=>(_(),g("div",N,[r("div",P,[(_(!0),g(C,null,R(y.messages,(c,t)=>(_(),g("div",{key:t},[r("strong",null,x(c.user)+":",1),j(" "+x(c.text),1)]))),128))]),D(r("input",{"onUpdate:modelValue":i[0]||(i[0]=c=>d.value=c),onKeyup:V(p,["enter"]),class:"border rounded-xl w-full p-2",placeholder:"发送消息..."},null,544),[[M,d.value]])]))}},A={class:"live-room p-4"},F={class:"text-xl font-bold mb-4"},K={class:"video-section grid grid-cols-2 gap-4"},q={__name:"LiveRoom",setup(y){const m=S(),l=m.params.roomId,p=m.params.role==="host",v=h(null),i=h(null),c=h([]),t=B("http://localhost:3005");t.on("chat-message",e=>c.value.push(e));const k=e=>{t.emit("chat-message",{user:"Me",text:e,roomId:l}),c.value.push({user:"Me",text:e})},f=new Map;let n=null;const b=async()=>{n=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),v.value.srcObject=n,t.emit("join-room",{roomId:l,role:"host"}),t.on("new-viewer",async({viewerId:e})=>{const s=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});n.getTracks().forEach(u=>s.addTrack(u,n)),s.onicecandidate=u=>{u.candidate&&t.emit("ice-candidate",{candidate:u.candidate,target:e})};const a=await s.createOffer();await s.setLocalDescription(a),t.emit("offer",{offer:a,viewerId:e}),f.set(e,s)}),t.on("answer",({answer:e,from:s})=>{const a=f.get(s);a&&a.setRemoteDescription(new RTCSessionDescription(e))}),t.on("ice-candidate",({candidate:e,from:s})=>{const a=f.get(s);a&&a.addIceCandidate(e)})};let o=null,w=null;const T=async()=>{t.emit("join-room",{roomId:l,role:"viewer"}),o=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),o.ontrack=e=>{i.value.srcObject=e.streams[0]},o.onicecandidate=e=>{e.candidate&&w&&t.emit("ice-candidate",{candidate:e.candidate,target:w})},t.on("offer",async({offer:e,from:s})=>{w=s,await o.setRemoteDescription(new RTCSessionDescription(e)),n=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),v.value.srcObject=n,n.getTracks().forEach(u=>o.addTrack(u,n));const a=await o.createAnswer();await o.setLocalDescription(a),t.emit("answer",{answer:a,hostId:s})}),t.on("ice-candidate",({candidate:e})=>{e&&o&&o.addIceCandidate(e)}),t.on("host-left",()=>{i.value&&(i.value.srcObject=null)})};return E(()=>{p?b():T()}),I(()=>{n&&n.getTracks().forEach(e=>e.stop()),o&&o.close(),f.forEach(e=>e.close()),t.disconnect()}),(e,s)=>(_(),g("div",A,[r("h1",F,"直播间 - "+x(U(l)),1),r("div",K,[r("video",{ref_key:"localVideo",ref:v,autoplay:"",playsinline:"",muted:p,class:"rounded-xl shadow"},null,512),r("video",{ref_key:"remoteVideo",ref:i,autoplay:"",playsinline:"",class:"rounded-xl shadow"},null,512)]),O($,{messages:c.value,onSend:k},null,8,["messages"])]))}},G=L(q,[["__scopeId","data-v-536b9027"]]);export{G as default};
